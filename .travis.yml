# To great extend copied from https://github.com/remkop/picocli-native-image-maven-demo/blob/master/.travis.yml
jobs:
  include:
    - os: linux
      env: JAVA_HOME="$HOME/.sdkman/candidates/java/current"

before_install:
  # adding $HOME/.sdkman to cache would create an empty directory, which interferes with the initial installation
  - "[[ -d $HOME/.sdkman/ ]] && [[ -d $HOME/.sdkman/bin/ ]] || rm -rf $HOME/.sdkman/"
  - curl -sL https://get.sdkman.io | bash
  - mkdir -p "$HOME/.sdkman/etc/"
  - echo sdkman_auto_answer=true > "$HOME/.sdkman/etc/config"
  - echo sdkman_auto_selfupdate=true >> "$HOME/.sdkman/etc/config"
  - ls "$HOME/.sdkman"
  - "source $HOME/.sdkman/bin/sdkman-init.sh"

install:
#  - if [ $TRAVIS_TAG != "" ]; then native-image --version ; fi
  - sdk current java
  - echo $JAVA_HOME
  - sdk current java | grep '19.3.1.r11-grl' || sdk install java 19.3.1.r11-grl
  - echo $JAVA_HOME
  - gu install native-image
  - native-image --version
  - sdk install sbt

script:
  - java -version
  - sbt assembly
  # TODO: unhardcode artifact version
  - native-image --verbose --static --no-fallback -jar target/scala-2.13/teleport-scala-assembly-0.1.0.jar teleport-scala

deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file: teleport-scala
  skip_cleanup: true
  on:
    tags: true
